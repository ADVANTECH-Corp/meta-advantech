From d3095bfadcd33db3b00c703927b271d9b6697094 Mon Sep 17 00:00:00 2001
From: Your Name <you@example.com>
Date: Fri, 20 May 2016 13:47:35 +0800
Subject: [PATCH] Add dustwsn init module & enable


diff --git a/drivers/misc/Kconfig b/drivers/misc/Kconfig
old mode 100644
new mode 100755
index fa77f81..ce61f9b
--- a/drivers/misc/Kconfig
+++ b/drivers/misc/Kconfig
@@ -535,6 +535,10 @@ config VEXPRESS_SYSCFG
 	  bus. System Configuration interface is one of the possible means
 	  of generating transactions on this bus.
 
+config ADVANTECH_DUSTWSN
+	tristate "Support Advantech DustWSN module"
+	depends on ARCH_ADVANTECH
+
 source "drivers/misc/c2port/Kconfig"
 source "drivers/misc/eeprom/Kconfig"
 source "drivers/misc/cb710/Kconfig"
diff --git a/drivers/misc/Makefile b/drivers/misc/Makefile
old mode 100644
new mode 100755
index 89a3328..9e4b011
--- a/drivers/misc/Makefile
+++ b/drivers/misc/Makefile
@@ -57,4 +57,6 @@ obj-y				+= mic/
 obj-$(CONFIG_GENWQE)		+= genwqe/
 obj-$(CONFIG_ECHO)		+= echo/
 obj-$(CONFIG_VEXPRESS_SYSCFG)	+= vexpress-syscfg.o
+obj-$(CONFIG_ADVANTECH_DUSTWSN)	+= adv-dustwsn.o
 obj-$(CONFIG_CXL_BASE)		+= cxl/
+obj-$(CONFIG_ADVANTECH_DUSTWSN)	+= adv-dustwsn.o
diff --git a/drivers/misc/adv-dustwsn.c b/drivers/misc/adv-dustwsn.c
new file mode 100644
index 0000000..9e8eb58
--- /dev/null
+++ b/drivers/misc/adv-dustwsn.c
@@ -0,0 +1,99 @@
+#ifdef CONFIG_ARCH_ADVANTECH
+/*
+ * Advantech Dust WSN module
+ *
+ * Copyright (C) 2015 Advantech Co.,Ltd.
+ *
+ */
+
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/of.h>
+#include <linux/platform_device.h>
+#include <linux/gpio.h>
+#include <linux/module.h>
+#include <linux/delay.h>
+
+#define IMX_GPIO_NR(bank, nr)		(((bank) - 1) * 32 + (nr))
+
+static int __init advantech_dustwsn_probe(struct platform_device *pdev)
+{
+	struct device_node *np = pdev->dev.of_node;
+
+	dev_info(&pdev->dev, "Advantech Dust WSN module init...\n");
+	/* no device tree device */
+	if (!np)
+	{
+		dev_err(&pdev->dev, "no device tree device...\n");
+		return -1;
+	}
+
+	/* Enable GPIO */
+    gpio_request(IMX_GPIO_NR(1,0), "gpio-0");
+    gpio_request(IMX_GPIO_NR(1,1), "gpio-1");
+    gpio_request(IMX_GPIO_NR(1,2), "gpio-2");
+    gpio_request(IMX_GPIO_NR(1,3), "gpio-3");
+    gpio_request(IMX_GPIO_NR(1,4), "gpio-4");
+    gpio_request(IMX_GPIO_NR(1,5), "gpio-5");
+    gpio_request(IMX_GPIO_NR(1,6), "gpio-6");
+    gpio_request(IMX_GPIO_NR(1,7), "gpio-7");
+
+    gpio_direction_output(IMX_GPIO_NR(1,0), 0);
+    gpio_direction_output(IMX_GPIO_NR(1,1), 0);
+    gpio_direction_output(IMX_GPIO_NR(1,2), 0);
+    gpio_direction_output(IMX_GPIO_NR(1,3), 0);
+    gpio_direction_output(IMX_GPIO_NR(1,4), 0);
+    gpio_direction_output(IMX_GPIO_NR(1,5), 0);
+    gpio_direction_output(IMX_GPIO_NR(1,6), 0);
+    gpio_direction_output(IMX_GPIO_NR(1,7), 0);
+
+    gpio_set_value(IMX_GPIO_NR(1,0), 0);
+    gpio_set_value(IMX_GPIO_NR(1,1), 0);
+    gpio_set_value(IMX_GPIO_NR(1,2), 0);
+    gpio_set_value(IMX_GPIO_NR(1,3), 0);
+    gpio_set_value(IMX_GPIO_NR(1,4), 0);
+    gpio_set_value(IMX_GPIO_NR(1,5), 0);
+    gpio_set_value(IMX_GPIO_NR(1,6), 0);
+    gpio_set_value(IMX_GPIO_NR(1,7), 0);
+
+    gpio_set_value(IMX_GPIO_NR(1,1), 1);
+    gpio_set_value(IMX_GPIO_NR(1,5), 1);
+    mdelay(5);
+    gpio_set_value(IMX_GPIO_NR(1,1), 0);
+    gpio_set_value(IMX_GPIO_NR(1,5), 0);
+
+	return 0;
+}
+
+static int __exit advantech_dustwsn_remove(struct platform_device *pdev)
+{
+	dev_info(&pdev->dev, "Remove Advantech Dust WSN module...\n");
+	return 0;
+}
+
+#ifdef CONFIG_OF
+static struct of_device_id advantech_dustwsn_dt_ids[] = {
+	{ .compatible = "adv,dustwsn" },
+	{}
+};
+MODULE_DEVICE_TABLE(of, advantech_dustwsn_dt_ids);
+#else
+#define advantech_dustwsn_dt_ids NULL
+#endif
+
+static struct platform_driver advantech_dustwsn_driver = {
+	.driver = {
+		.name = "adv-dustwsn",
+		.owner = THIS_MODULE,
+		.of_match_table = of_match_ptr(advantech_dustwsn_dt_ids),
+	},
+	.remove = __exit_p(advantech_dustwsn_remove),
+};
+
+module_platform_driver_probe(advantech_dustwsn_driver, advantech_dustwsn_probe);
+
+MODULE_AUTHOR("Advantech");
+MODULE_DESCRIPTION("Advantech Dust WSN init Module");
+MODULE_LICENSE("GPL");
+
+#endif
-- 
1.7.9.5

