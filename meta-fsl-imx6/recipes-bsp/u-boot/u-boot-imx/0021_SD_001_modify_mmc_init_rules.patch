From 72b960715676ceef46b9a3def54808410076e4a0 Mon Sep 17 00:00:00 2001
From: Your Name <you@example.com>
Date: Thu, 17 Mar 2016 14:00:45 +0800
Subject: [PATCH] modify sd


diff --git a/board/freescale/mx6advantech/mx6advantech.c b/board/freescale/mx6advantech/mx6advantech.c
old mode 100644
new mode 100755
index 22ece56..d62c475
--- a/board/freescale/mx6advantech/mx6advantech.c
+++ b/board/freescale/mx6advantech/mx6advantech.c
@@ -179,7 +179,7 @@ static iomux_v3_cfg_t const usdhc3_pads[] = {
 	MX6_PAD_SD3_DAT6__SD3_DATA6 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
 	MX6_PAD_SD3_DAT7__SD3_DATA7 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
 	MX6_PAD_NANDF_D0__GPIO2_IO00    | MUX_PAD_CTRL(NO_PAD_CTRL), /* CD */
-#ifdef CONFIG_TWO_SD_BOOT
+#ifdef USDHC3_PWREN_GPIO
 	MX6_PAD_NANDF_D2__GPIO2_IO02    | MUX_PAD_CTRL(NO_PAD_CTRL), /* PWREN */
 #endif
 };
@@ -345,15 +345,9 @@ static void setup_iomux_uart(void)
 
 #ifdef CONFIG_FSL_ESDHC
 struct fsl_esdhc_cfg usdhc_cfg[3] = {
-#ifndef CONFIG_TWO_SD_BOOT 
 	{USDHC2_BASE_ADDR},
 	{USDHC3_BASE_ADDR},
 	{USDHC4_BASE_ADDR},
-#else
-	{USDHC2_BASE_ADDR},
-	{USDHC4_BASE_ADDR},
-	{USDHC3_BASE_ADDR},
-#endif
 };
 
 int mmc_get_env_devno(void)
@@ -392,12 +386,16 @@ int board_mmc_getcd(struct mmc *mmc)
 	int ret = 0;
 
 	switch (cfg->esdhc_base) {
+#ifdef USDHC2_CD_GPIO
 	case USDHC2_BASE_ADDR:
 		ret = !gpio_get_value(USDHC2_CD_GPIO);
 		break;
+#endif
+#ifdef USDHC3_CD_GPIO
 	case USDHC3_BASE_ADDR:
 		ret = !gpio_get_value(USDHC3_CD_GPIO);
 		break;
+#endif
 	case USDHC4_BASE_ADDR:
 		ret = 1; /* eMMC/uSDHC4 is always present */
 		break;
@@ -420,53 +418,34 @@ int board_mmc_init(bd_t *bis)
 	 */
 	for (i = 0; i < CONFIG_SYS_FSL_USDHC_NUM; i++) {
 		switch (i) {
+#ifdef USDHC2_CD_GPIO
 		case 0:
 			imx_iomux_v3_setup_multiple_pads(
 				usdhc2_pads, ARRAY_SIZE(usdhc2_pads));
 			gpio_direction_input(USDHC2_CD_GPIO);
-			usdhc_cfg[0].sdhc_clk = mxc_get_clock(MXC_ESDHC2_CLK);
+			usdhc_cfg[i].sdhc_clk = mxc_get_clock(MXC_ESDHC2_CLK);
+			ret = fsl_esdhc_initialize(bis, &usdhc_cfg[i]);
 			break;
+#endif
+#ifdef USDHC3_CD_GPIO
 		case 1:
-#ifndef	CONFIG_TWO_SD_BOOT
 			imx_iomux_v3_setup_multiple_pads(
 				usdhc3_pads, ARRAY_SIZE(usdhc3_pads));
 			gpio_direction_input(USDHC3_CD_GPIO);
-			usdhc_cfg[1].sdhc_clk = mxc_get_clock(MXC_ESDHC3_CLK);
-#else
-			imx_iomux_v3_setup_multiple_pads(
-				usdhc4_pads, ARRAY_SIZE(usdhc4_pads));
-			usdhc_cfg[1].sdhc_clk = mxc_get_clock(MXC_ESDHC4_CLK);
+#ifdef USDHC3_PWREN_GPIO
+			gpio_direction_output(USDHC3_PWREN_GPIO, 0);
 #endif
+			usdhc_cfg[i].sdhc_clk = mxc_get_clock(MXC_ESDHC3_CLK);
+			ret = fsl_esdhc_initialize(bis, &usdhc_cfg[i]);
 			break;
+#endif
 		case 2:
-#ifndef	CONFIG_TWO_SD_BOOT
 			imx_iomux_v3_setup_multiple_pads(
 				usdhc4_pads, ARRAY_SIZE(usdhc4_pads));
-			usdhc_cfg[2].sdhc_clk = mxc_get_clock(MXC_ESDHC4_CLK);
-#else
-			imx_iomux_v3_setup_multiple_pads(
-				usdhc3_pads, ARRAY_SIZE(usdhc3_pads));
-			gpio_direction_output(USDHC3_PWREN_GPIO, 0);
-			gpio_direction_input(USDHC3_CD_GPIO);
-			usdhc_cfg[2].sdhc_clk = mxc_get_clock(MXC_ESDHC3_CLK);
-#endif
+			usdhc_cfg[i].sdhc_clk = mxc_get_clock(MXC_ESDHC4_CLK);
+			ret = fsl_esdhc_initialize(bis, &usdhc_cfg[i]);
 			break;
-		default:
-			printf("Warning: you configured more USDHC controllers"
-			       "(%d) then supported by the board (%d)\n",
-			       i + 1, CONFIG_SYS_FSL_USDHC_NUM);
-			return -EINVAL;
 		}
-#ifndef CONFIG_TWO_SD_BOOT
-		/* We use index 1 for SD card and index 3 for eMMC */
-		if (i != 1) {
-			ret = fsl_esdhc_initialize(bis, &usdhc_cfg[i]);
-			}
-#else
-		/* ROM-7421: We use index 1 for Micro SD card,  index 3 for eMMC and index 5 for carrier SD card */
-		/* Others: We use index 1 for SD card,  index 3 for eMMC */
-		ret = fsl_esdhc_initialize(bis, &usdhc_cfg[i]);
-#endif
 		if (ret)
 			return ret;
 	}
-- 
1.7.9.5

