From 1d9fd458817b393b550e475affe6129c31a5ac43 Mon Sep 17 00:00:00 2001
From: Your Name <you@example.com>
Date: Thu, 21 Jan 2016 17:01:27 +0800
Subject: [PATCH] twosd1


diff --git a/board/freescale/mx6advantech/mx6advantech.c b/board/freescale/mx6advantech/mx6advantech.c
index e5de79b..51a8db9 100755
--- a/board/freescale/mx6advantech/mx6advantech.c
+++ b/board/freescale/mx6advantech/mx6advantech.c
@@ -179,6 +179,9 @@ static iomux_v3_cfg_t const usdhc3_pads[] = {
 	MX6_PAD_SD3_DAT6__SD3_DATA6 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
 	MX6_PAD_SD3_DAT7__SD3_DATA7 | MUX_PAD_CTRL(USDHC_PAD_CTRL),
 	MX6_PAD_NANDF_D0__GPIO2_IO00    | MUX_PAD_CTRL(NO_PAD_CTRL), /* CD */
+#ifdef CONFIG_TWO_SD_BOOT
+	MX6_PAD_NANDF_D2__GPIO2_IO02    | MUX_PAD_CTRL(NO_PAD_CTRL), /* PWREN */
+#endif
 };
 
 static iomux_v3_cfg_t const usdhc4_pads[] = {
@@ -342,9 +345,15 @@ static void setup_iomux_uart(void)
 
 #ifdef CONFIG_FSL_ESDHC
 struct fsl_esdhc_cfg usdhc_cfg[3] = {
+#ifndef CONFIG_TWO_SD_BOOT 
 	{USDHC2_BASE_ADDR},
 	{USDHC3_BASE_ADDR},
 	{USDHC4_BASE_ADDR},
+#else
+	{USDHC2_BASE_ADDR},
+	{USDHC4_BASE_ADDR},
+	{USDHC3_BASE_ADDR},
+#endif
 };
 
 int mmc_get_env_devno(void)
@@ -419,15 +428,29 @@ int board_mmc_init(bd_t *bis)
 			usdhc_cfg[0].sdhc_clk = mxc_get_clock(MXC_ESDHC2_CLK);
 			break;
 		case 1:
+#ifndef	CONFIG_TWO_SD_BOOT
 			imx_iomux_v3_setup_multiple_pads(
 				usdhc3_pads, ARRAY_SIZE(usdhc3_pads));
 			gpio_direction_input(USDHC3_CD_GPIO);
 			usdhc_cfg[1].sdhc_clk = mxc_get_clock(MXC_ESDHC3_CLK);
+#else
+			imx_iomux_v3_setup_multiple_pads(
+				usdhc4_pads, ARRAY_SIZE(usdhc4_pads));
+			usdhc_cfg[1].sdhc_clk = mxc_get_clock(MXC_ESDHC4_CLK);
+#endif
 			break;
 		case 2:
+#ifndef	CONFIG_TWO_SD_BOOT
 			imx_iomux_v3_setup_multiple_pads(
 				usdhc4_pads, ARRAY_SIZE(usdhc4_pads));
 			usdhc_cfg[2].sdhc_clk = mxc_get_clock(MXC_ESDHC4_CLK);
+#else
+			imx_iomux_v3_setup_multiple_pads(
+				usdhc3_pads, ARRAY_SIZE(usdhc3_pads));
+			gpio_direction_output(USDHC3_PWREN_GPIO, 0);
+			gpio_direction_input(USDHC3_CD_GPIO);
+			usdhc_cfg[2].sdhc_clk = mxc_get_clock(MXC_ESDHC3_CLK);
+#endif
 			break;
 		default:
 			printf("Warning: you configured more USDHC controllers"
@@ -435,12 +458,14 @@ int board_mmc_init(bd_t *bis)
 			       i + 1, CONFIG_SYS_FSL_USDHC_NUM);
 			return -EINVAL;
 		}
-#ifdef CONFIG_ADVANTECH
+#ifndef CONFIG_TWO_SD_BOOT
 		/* We use index 1 for SD card and index 3 for eMMC */
 		if (i != 1) {
 			ret = fsl_esdhc_initialize(bis, &usdhc_cfg[i]);
 			}
 #else
+		/* ROM-7421: We use index 1 for Micro SD card,  index 3 for eMMC and index 5 for carrier SD card */
+		/* Others: We use index 1 for SD card,  index 3 for eMMC */
 		ret = fsl_esdhc_initialize(bis, &usdhc_cfg[i]);
 #endif
 		if (ret)
-- 
1.7.9.5

